#!/usr/bin/python

import sys
import os
from subprocess import Popen, PIPE

DOCUMENTATION = '''
---
module: aws_codedeploy
short_description: Installs and starts the AWS CodeDeploy Agent
description:
  - Installs and starts the AWS CodeDeploy Agent
version_added: 0.0
author: Andrew Fitz Gibbon
options:
  enabled:
    description:
      - Enable the agent
     choices: ["yes", "no"]
     required: true
'''

try:
    import boto
    from boto.s3.connection import Location
    from boto.utils import get_instance_metadata
except ImportError:
    print("failed=True msg='boto required for this module'")
    sys.exit(1)

def on_ec2():
    try:
        instance_metadata = get_instance_metadata(timeout=2, num_retries=2)
        if 'instance-id' in instance_metadata.keys() and len(instance_metadata['instance-id']) > 0:
            return True
        else:
            return False
    except:
        return False

def run_command(command):
    process = Popen(command, stdout=PIPE, stderr=PIPE, shell=True)
    output, error = process.communicate()
    return process.returncode, output, error

def install_codedeploy_agent():
    commands = [
        'sudo yum update -y',
        'sudo yum install -y ruby',
        'sudo yum install -y wget',
        'wget https://aws-codedeploy-us-east-1.s3.us-east-1.amazonaws.com/latest/install',
        'chmod +x ./install',
        'sudo ./install auto',
        'sudo service codedeploy-agent start'
    ]

    for cmd in commands:
        return_code, output, error = run_command(cmd)
        if return_code != 0:
            sys.exit("Failed to execute command: {}\nError: {}".format(cmd, error.decode()))

def main():
    module = AnsibleModule(
        argument_spec=dict(
            enabled=dict(required=True, choices=BOOLEANS)
        )
    )

    if not on_ec2():
        module.fail_json(msg="must install the AWS CodeDeploy on an EC2 instance")

    try:
        install_codedeploy_agent()
    except Exception as e:
        module.fail_json(msg=str(e))

    module.exit_json(installed=True)

from ansible.module_utils.basic import *
main()
